## 18.2 Blender导出骨骼动画

要导出哪些数据呢？

我们制作骨骼动画的时候，是先用父节点做大的摆动，然后再调整子节点。

子节点的坐标，是叠加了父节点的。

所以我们要导出节点间的父子关系，子节点相对父节点的位移。
以及每一帧父节点的移动，子节点的移动。

在Blender中可以很方便的用Python进行插件开发，具体如何运行插件代码在之前的第8章 绘制静态模型已经介绍过了。

我编写了一小段代码，将骨骼动画数据导出到自定义的格式。

https://docs.blender.org/api/2.93/bpy.context.html#bpy.context.visible_objects

https://gamedev.stackexchange.com/questions/44058/exporting-bind-and-keyframe-bone-poses-from-blender-to-use-in-opengl

先导出T-POS，所有Bone关节点的矩阵

```python
if bpy.ops.object.mode_set.poll():
    bpy.ops.object.mode_set(mode='OBJECT')

#export bone T-POS matrix
for obj in bpy.context.visible_objects:
    if obj.type == "ARMATURE" and obj.users !=0:
        for bone in obj.data.bones:
            print('--------')
            print('name:%s, parent:%s' %(bone.name, bone.parent))
            print('head local:'+ str(bone.head_local))
            print('head:'+ str(bone.head))
            print('matrix_local:\n'+ str(bone.matrix_local))
```


然后导出动画每一帧的Bone矩阵

```python
#anim frame count
print("frame_end:" + str(bpy.context.scene.frame_end))
#loop all anim frame
for frame_index in range(bpy.context.scene.frame_end):
    real_frame_index = frame_index + 1
    print("******** real_frame_index:" + str(real_frame_index))
    #set anim frame to n,to get bone matrix
    bpy.context.scene.frame_set(real_frame_index)
    
    for i in range(0, len(bpy.context.visible_pose_bones)):
        bone = bpy.context.visible_pose_bones[i]
        print(bone)
        print(bone.matrix)
```

```python
real_frame_index = frame_index + 1
```



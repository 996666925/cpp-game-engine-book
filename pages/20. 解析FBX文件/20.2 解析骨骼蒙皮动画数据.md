## 20.2 解析骨骼蒙皮动画数据

导出骨骼动画数据时，很容易被矩阵主序、Y轴朝向这些问题困住。

我的经验是，将之前在Blender中做的骨骼蒙皮动画导出一份fbx来测试，观察从Assimp中获取的数据，与Blender中导出的数据，对比差异，然后再去调整代码。

参考资料：

```text
Assimp Bones
https://assimp-docs.readthedocs.io/en/latest/usage/use_the_lib.html#bones

Assimp Animation
https://assimp-docs.readthedocs.io/en/latest/usage/use_the_lib.html#animations
```

```c++
//判断是否有蒙皮
const bool lHasSkin = lMesh->GetDeformerCount(FbxDeformer::eSkin) > 0;
```

DrawScene.cxx 

```c++
void DrawMesh(FbxNode* pNode, FbxTime& pTime, FbxAnimLayer* pAnimLayer,
              FbxAMatrix& pGlobalPosition, FbxPose* pPose, ShadingMode pShadingMode)
```

绘制蒙皮。

权重

```c++
// Deform the vertex array in classic linear way.
void ComputeLinearDeformation(FbxAMatrix& pGlobalPosition, 
                               FbxMesh* pMesh, 
                               FbxTime& pTime, 
                               FbxVector4* pVertexArray,
							   FbxPose* pPose)

                               
```

	// For all skins and all clusters, accumulate their deformation and weight
	// on each vertices and store them in lClusterDeformation and lClusterWeight.

对于所有皮肤和所有簇，在每个顶点上累积它们的变形和权重，并将它们存储在 lClusterDeformation 和 lClusterWeight 中。 

```c++
int lVertexIndexCount = lCluster->GetControlPointIndicesCount();

返回这个簇关联的顶点，应该是这个Bone关联的顶点。

// Compute the influence of the link on the vertex.
FbxAMatrix lInfluence = lVertexTransformMatrix;
MatrixScale(lInfluence, lWeight);

直接把权重作用到矩阵上就行。
```


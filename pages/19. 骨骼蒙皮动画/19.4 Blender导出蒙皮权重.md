## 19.4 Blender导出蒙皮权重

在Blender中做完蒙皮，并且刷好权重之后，就可以导出了。

前面已经介绍了如何导出Mesh，以及骨骼动画，那么现在只要导出顶点关联的骨骼序号以及对应权重即可。

其实就是导出 `19.2 骨骼权重` 手动创建的数据，如下：

```lua
--file:example/login_scene.lua line:53

--顶点关联骨骼信息,按照 bone_index_[4] bone_weight_[4] 的顺序存储
local vertex_relate_bone_infos=sol2.convert_sequence_int({
    0, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第一个顶点：关联骨骼0，权重是1。注意-1表示无骨骼。
    0, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第二个顶点同理
    0, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第三个顶点同理
    0, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第四个顶点同理

    0,  1, -1, -1, --[[左边骨骼，右边权重]] 70,  30, -1, -1,--第一个顶点：关联骨骼0，权重0.7，关联骨骼1，权重0.3。
    0, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第二个顶点：关联骨骼0，权重1.
    1, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第三个顶点：关联骨骼1，权重1.
    1, -1, -1, -1, --[[左边骨骼，右边权重]] 100, -1, -1, -1,--第四个顶点：关联骨骼1，权重1.
})
mesh_filter:set_vertex_relate_bone_infos(vertex_relate_bone_infos)
```

只不过上面是在Lua中手动创建的数据，受限于Lua的API，没法直接以内存的形式传递，而是从`table`转成了`vector`，再遍历拷贝。

在Blender中导出，可以直接导出更符合内存结构的数据到文件中，在引擎中就只要加载然后`memcpy`，速度更快。

来看一下之前的代码，单个顶点关联的骨骼及权重，用结构`VertexRelateBoneInfo`来存储。

```c++
//file:source/renderer/mesh_filter.h line:84

/// 顶点关联骨骼及权重,每个顶点最多可以关联4个骨骼。
struct VertexRelateBoneInfo{
    char bone_index_[4];//骨骼索引，一般骨骼少于128个，用char就行。
    char bone_weight_[4];//骨骼权重，权重不会超过100，所以用char类型就可以。
};
```

所有顶点关联的骨骼权重，存储在`MeshFilter::vertex_relate_bone_infos_`中：

```c++
private:
    ......
    VertexRelateBoneInfo* vertex_relate_bone_infos_= nullptr;//顶点关联骨骼信息(4个骨骼索引、权重)，长度为顶点数
```

按照这个结构，只要将Lua中手动创建的数据格式，一个一个数字写入到文件就行了。

读取的时候再读取整段数据，`memcpy`即可。

下面就来看如何导出吧。

### 导出蒙皮权重数据

